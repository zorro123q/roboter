<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenClaw Lite</title>
<style>
    /* === å…¨å±€å¸ƒå±€ === */
    body {
        font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
        padding: 20px;
        background: #f0f2f5;
        height: 95vh;
        margin: 0;
        display: flex;
        flex-direction: column;
    }

    .box {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* === é¡¶éƒ¨æ ‡é¢˜æ  === */
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    h2 { margin: 0; color: #1a73e8; font-size: 20px; }
    .subtitle { font-size: 12px; color: #666; font-weight: normal; margin-left: 5px; }

    /* === æŒ‰é’®æ ·å¼ === */
    button {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-size: 13px;
        transition: all 0.2s;
    }
    .btn-sync { background: #34a853; color: white; }
    .btn-sync:hover { background: #2d8e47; }
    .btn-sync:disabled { background: #ccc; cursor: not-allowed; }

    .btn-clear { background: #f0f2f5; color: #666; margin-right: 10px; }
    .btn-clear:hover { background: #e0e0e0; color: #333; }

    .btn-send { background: #1a73e8; color: white; padding: 10px 24px; }
    .btn-send:hover { background: #1557b0; }

    /* === ğŸ“‚ æ–‡ä»¶åˆ—è¡¨é¢æ¿ (æ–°å¢) === */
    #fileListPanel {
        display: none; /* é»˜è®¤éšè— */
        margin-bottom: 15px;
        padding: 12px;
        background: #f8f9fa;
        border: 1px dashed #ccc;
        border-radius: 8px;
        font-size: 13px;
        color: #444;
        max-height: 120px;
        overflow-y: auto;
    }
    .file-item { display: flex; align-items: center; margin-bottom: 4px; }
    .file-icon { margin-right: 6px; }
    .file-chunks { margin-left: auto; color: #888; font-size: 12px; background: #eee; padding: 2px 6px; border-radius: 4px; }

    /* === èŠå¤©åŒºåŸŸ === */
    #chatBox {
        flex: 1;
        overflow-y: auto;
        padding-right: 10px;
        margin-bottom: 15px;
        scroll-behavior: smooth;
    }

    /* æ¶ˆæ¯æ°”æ³¡ */
    .msg {
        margin: 12px 0;
        padding: 12px 16px;
        border-radius: 8px;
        max-width: 85%;
        line-height: 1.6;
        word-wrap: break-word;
        font-size: 14px;
        position: relative;
    }
    .user {
        background: #e8f0fe;
        color: #1967d2;
        margin-left: auto;
        border-bottom-right-radius: 2px;
    }
    .bot {
        background: #f1f3f4;
        color: #202124;
        margin-right: auto;
        border-bottom-left-radius: 2px;
    }

    /* ğŸ› ï¸ Agent æ€è€ƒè¿‡ç¨‹ (é»‘å®¢é£æ ¼) */
    .steps {
        background: #2b2b2b;
        color: #a9b7c6;
        font-family: Consolas, "Courier New", monospace;
        font-size: 12px;
        padding: 12px;
        margin: 8px 0;
        border-radius: 6px;
        white-space: pre-wrap;
        border-left: 4px solid #34a853;
        display: none; /* æœ‰å†…å®¹æ‰æ˜¾ç¤º */
    }

    /* === åº•éƒ¨è¾“å…¥æ¡† === */
    .input-area { display: flex; gap: 10px; padding-top: 10px; border-top: 1px solid #eee; }
    input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        outline: none;
        transition: border 0.2s;
        font-size: 14px;
    }
    input:focus { border-color: #1a73e8; box-shadow: 0 0 0 2px rgba(26,115,232,0.1); }
</style>
</head>
<body>

<div class="box">
    <div class="header">
        <div>
            <h2>ğŸ¤– OpenClaw Lite <span class="subtitle">(Agentç‰ˆ)</span></h2>
        </div>
        <div>
            <button onclick="clearHistory()" class="btn-clear" title="æ¸…ç©ºèŠå¤©è®°å½•">ğŸ—‘ï¸ æ¸…ç©º</button>
            <button onclick="sync()" id="btnSync" class="btn-sync">ğŸ“š åŒæ­¥æ–‡æ¡£</button>
        </div>
    </div>

    <div id="fileListPanel"></div>

    <div id="chatBox">
        <div class="msg bot">ä½ å¥½ï¼æˆ‘æ˜¯å…·å¤‡ <b style="color:#1a73e8">ä»£ç æ‰§è¡Œèƒ½åŠ›</b> çš„ AI åŠ©æ‰‹ã€‚<br>
        æˆ‘å¯ä»¥å¸®ä½ åˆ†ææ–‡æ¡£ï¼Œæˆ–è€…ç¼–å†™ Python ä»£ç æ¥è®¡ç®—æ•°æ®ã€‚<br><br>
        <i>æç¤ºï¼šè¯·å…ˆç‚¹å‡»å³ä¸Šè§’â€œåŒæ­¥æ–‡æ¡£â€è¯»å– D ç›˜æ–‡ä»¶ã€‚</i></div>
    </div>

    <div class="input-area">
        <input type="text" id="ipt" placeholder="è¾“å…¥é—®é¢˜æˆ–æŒ‡ä»¤... (å›è½¦å‘é€)" onkeypress="if(event.keyCode==13) send()">
        <button onclick="send()" class="btn-send">å‘é€</button>
    </div>
</div>

<script>
    // === é¡µé¢åŠ è½½ï¼šå°è¯•è·å–å†å²è®°å½• ===
// === é¡µé¢åŠ è½½ï¼šè‡ªåŠ¨æ¢å¤èŠå¤©è®°å½• + æ¢å¤æ–‡ä»¶åˆ—è¡¨ ===
    window.onload = async () => {
        // 1. åŠ è½½èŠå¤©è®°å½•
        try {
            const res = await fetch('/get_history');
            const history = await res.json();
            if (history && history.length > 0) {
                const box = document.getElementById('chatBox');
                box.innerHTML = '';
                history.forEach(msg => {
                    const cls = msg.role === 'user' ? 'user' : 'bot';
                    box.innerHTML += `<div class="msg ${cls}">${formatText(msg.content)}</div>`;
                });
                box.innerHTML += '<div style="text-align:center; color:#999; font-size:12px; margin:10px;">--- ä»¥ä¸Šä¸ºå†å²è®°å½• ---</div>';
                box.scrollTop = box.scrollHeight;
            }
        } catch (e) { console.log("åŠ è½½å†å²å¤±è´¥"); }

        // 2. ğŸ†• åŠ è½½ä¸Šæ¬¡ä¿å­˜çš„çŸ¥è¯†åº“åˆ—è¡¨ (è®©ä½ çŸ¥é“ä¸ç”¨é‡æ–°è¯»äº†)
        try {
            const res = await fetch('/get_db_status');
            const data = await res.json();

            if (data.files && data.files.length > 0) {
                const listPanel = document.getElementById('fileListPanel');
                listPanel.style.display = 'block';

                let html = `<div style="margin-bottom:5px; font-weight:bold; color:#1a73e8;">
                                âš¡ å·²è‡ªåŠ¨åŠ è½½ç¼“å­˜çŸ¥è¯†åº“ (${data.total_chunks} ç‰‡æ®µ)
                            </div>`;

                data.files.forEach(f => {
                    // ç¼“å­˜æ–‡ä»¶çš„å›¾æ ‡ç”¨è“è‰²ï¼ŒåŒºåˆ«äºæ–°è¯»å–çš„ç»¿è‰²
                    html += `
                        <div class="file-item" style="color:#5f6368">
                            <span class="file-icon">ğŸ’¾</span>
                            <span>${f.name}</span>
                            <span class="file-chunks">${f.chunks} ç‰‡æ®µ</span>
                        </div>
                    `;
                });
                listPanel.innerHTML = html;
            }
        } catch (e) { console.log("åŠ è½½æ•°æ®åº“çŠ¶æ€å¤±è´¥"); }
    };

    // === åŠŸèƒ½ 1ï¼šåŒæ­¥æ–‡æ¡£å¹¶æ˜¾ç¤ºåˆ—è¡¨ ===
    async function sync() {
        const btn = document.getElementById('btnSync');
        const listPanel = document.getElementById('fileListPanel');

        // UI Loading
        const oldText = btn.innerText;
        btn.innerText = "â³ è¯»å–ä¸­...";
        btn.disabled = true;

        try {
            const res = await fetch('/sync_docs_get');
            const data = await res.json();

            // å¼¹çª—ç®€å•æç¤º
            alert(data.message);

            // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
            if (data.files && data.files.length > 0) {
                listPanel.style.display = 'block';
                let html = '<div style="margin-bottom:5px; font-weight:bold;">ğŸ“‚ D:\\MyAI_Assistant\\dist\\docs_input</div>';

                data.files.forEach(f => {
                    let icon = "âœ…";
                    let color = "#2d8e47";
                    let statusText = `${f.chunks} ç‰‡æ®µ`;

                    if(f.status === 'error') { icon = "âŒ"; color = "#d93025"; statusText = "è¯»å–å¤±è´¥"; }
                    if(f.status === 'empty') { icon = "âš ï¸"; color = "#f9ab00"; statusText = "ç©ºæ–‡ä»¶"; }

                    html += `
                        <div class="file-item" style="color:${color}">
                            <span class="file-icon">${icon}</span>
                            <span>${f.name}</span>
                            <span class="file-chunks">${statusText}</span>
                        </div>
                    `;
                });
                listPanel.innerHTML = html;
            } else {
                listPanel.style.display = 'block';
                listPanel.innerHTML = '<span style="color:#d93025;">ğŸ“‚ æ–‡ä»¶å¤¹ä¸ºç©ºï¼Œè¯·æ”¾å…¥ .docx æ–‡æ¡£</span>';
            }

        } catch (e) {
            alert("åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡: " + e.message);
        } finally {
            btn.innerText = oldText;
            btn.disabled = false;
        }
    }

    // === åŠŸèƒ½ 2ï¼šå‘é€æ¶ˆæ¯ ===
    async function send() {
        const ipt = document.getElementById('ipt');
        const box = document.getElementById('chatBox');
        const txt = ipt.value.trim();
        if(!txt) return;

        // 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        box.innerHTML += `<div class="msg user">${formatText(txt)}</div>`;
        ipt.value = '';
        box.scrollTop = box.scrollHeight;

        // 2. æ˜¾ç¤º Loading å ä½ç¬¦
        const loadId = "load-" + Date.now();
        box.innerHTML += `<div class="msg bot" id="${loadId}">ğŸ§  æ­£åœ¨æ€è€ƒå¹¶æ‰§è¡Œä»»åŠ¡...</div>`;
        box.scrollTop = box.scrollHeight;

        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({question: txt})
            });
            const data = await res.json();

            // 3. æ„å»ºå›å¤ HTML
            let finalHtml = "";

            // å¦‚æœæœ‰ Agent æ€è€ƒ/æ‰§è¡Œæ­¥éª¤ï¼Œæ˜¾ç¤ºåœ¨é»‘è‰²ç»ˆç«¯æ¡†é‡Œ
            if (data.steps && data.steps.length > 0) {
                finalHtml += `<div class="steps" style="display:block;">${data.steps.join('\n\n----------------\n\n')}</div>`;
            }

            // æ˜¾ç¤ºæœ€ç»ˆå›ç­” (æ”¯æŒç®€å•çš„æ¢è¡Œæ˜¾ç¤º)
            finalHtml += formatText(data.answer);

            document.getElementById(loadId).innerHTML = finalHtml;
        } catch (e) {
            document.getElementById(loadId).innerText = "âŒ å‘é€å¤±è´¥: " + e.message;
        }
        box.scrollTop = box.scrollHeight;
    }

    // === åŠŸèƒ½ 3ï¼šæ¸…ç©ºå†å² ===
    async function clearHistory() {
        if(!confirm("ç¡®å®šè¦åˆ é™¤æ‰€æœ‰è®°å¿†å—ï¼Ÿ")) return;
        try {
            await fetch('/clear_history', {method: 'POST'}); // å‡è®¾åç«¯æœ‰è¿™ä¸ªæ¥å£ï¼Œå¦‚æœæ²¡æœ‰ä¹Ÿæ²¡äº‹
            document.getElementById('chatBox').innerHTML = '<div class="msg bot">è®°å¿†å·²æ¸…é™¤ã€‚</div>';
            document.getElementById('fileListPanel').style.display = 'none'; // é¡ºä¾¿éšè—æ–‡ä»¶åˆ—è¡¨
        } catch(e) {
            alert("æ¸…é™¤å¤±è´¥");
        }
    }

    // ç®€å•çš„æ–‡æœ¬æ ¼å¼åŒ–ï¼ˆå¤„ç†æ¢è¡Œï¼‰
    function formatText(text) {
        if (!text) return "";
        return text.replace(/\n/g, '<br>');
    }
</script>
</body>
</html>